version: 2.1

jobs:
  say-hello:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: "Say hello"
          command: echo "Hello from CircleCI ðŸ‘‹"

  update_version_file:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Setup SSH Keys
          command: |
            mkdir -p ~/.ssh

            echo "$SSH_KEY_CIRCLECI" | base64 --decode > ~/.ssh/id_circleci
            chmod 600 ~/.ssh/id_circleci

            echo "$SSH_KEY_VERSWIN" | base64 --decode > ~/.ssh/id_verswin
            chmod 600 ~/.ssh/id_verswin

            ssh-keyscan github.com >> ~/.ssh/known_hosts

            # Ð”Ð¾Ð´Ð°Ð¹ Ñƒ SSH config, Ñ‰Ð¾Ð± ÐºÐ¾Ð¶ÐµÐ½ ÐºÐ»ÑŽÑ‡ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð² ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ repo
            echo "Host github.com-circleci
              HostName github.com
              User git
              IdentityFile ~/.ssh/id_circleci
              IdentitiesOnly yes" >> ~/.ssh/config

            echo "Host github.com-verswin
              HostName github.com
              User git
              IdentityFile ~/.ssh/id_verswin
              IdentitiesOnly yes" >> ~/.ssh/config

      - run:
          name: Clone verswin_control and update version.txt
          command: |
            git_hash=$(git -C ~/project rev-parse HEAD)

            git clone git@github.com-verswin:Rafaelkaaa/verswin_control.git
            cd verswin_control
            git checkout main || git checkout -b main

            echo "$git_hash" > version.txt

            if ! git diff --quiet; then
              git config user.name "CI Bot"
              git config user.email "ci-bot@rafaelkaaa.net"
              git add version.txt
              git commit -m "Update version.txt with latest commit hash"
              git push origin main
            else
              echo "No changes to commit"
            fi
workflows:
  version: 2
  run-all:
    jobs:
      - say-hello
      - update_version_file:
          filters:
            branches:
              only:
                - main
                - develop
