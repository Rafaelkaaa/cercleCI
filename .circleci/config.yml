version: 2.1

jobs:
  update_version_file:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Setup SSH Keys
          command: |
            mkdir -p ~/.ssh

            echo "$SSH_KEY_CIRCLECI" | base64 --decode > ~/.ssh/id_circleci
            chmod 600 ~/.ssh/id_circleci

            echo "$SSH_KEY_VERSWIN" | base64 --decode > ~/.ssh/id_verswin
            chmod 600 ~/.ssh/id_verswin

            ssh-keyscan github.com >> ~/.ssh/known_hosts

            # Додай у SSH config, щоб кожен ключ відповідав конкретному repo
            echo "Host github.com-circleci
              HostName github.com
              User git
              IdentityFile ~/.ssh/id_circleci
              IdentitiesOnly yes" >> ~/.ssh/config

            echo "Host github.com-verswin
              HostName github.com
              User git
              IdentityFile ~/.ssh/id_verswin
              IdentitiesOnly yes" >> ~/.ssh/config

      - run:
          name: Clone verswin_control and update version.txt
          command: |
            git_hash=$(git rev-parse HEAD)

            git clone git@github.com:Rafaelkaaa/verswin_control.git
            cd verswin_control
            git checkout main || git checkout -b main

            echo "$git_hash" > version.txt

            if ! git diff --quiet; then
              git config user.name "CI Bot"
              git config user.email "ci-bot@rafaelkaaa.net"
              git add version.txt
              git commit -m "Update version.txt with latest commit hash"
              git push origin main
            else
              echo "No changes to commit"
            fi
workflows:
  version: 2
  run-all:
    jobs:
      - update_version_file:
          filters:
            branches:
              only:
                - main
                - develop
